<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Problem | AI Coding Practice</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="page-shell">
  <nav class="navbar">
    <div class="brand"><span class="logo"></span> AI Coding Practice</div>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a class="active" href="/practice.html">Practice</a></li>
      <li class="user-area"></li>
    </ul>
  </nav>

  <main class="split">
    <section class="left">
      <div id="problem">
        <header class="page-header" style="padding-left:0;padding-right:0;">
          <h1 id="title" class="page-title">Loading...</h1>
          <div id="meta" class="page-sub"></div>
          <div id="tags" class="chips"></div>
        </header>
        <pre id="statement" class="statement"></pre>
      </div>
      <div class="problem-toolbar">
        <label>Language:
          <select id="language">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
          </select>
        </label>
        <div class="controls">
          <button id="runBtn" class="btn">Run</button>
          <button id="formatBtn" class="btn">Format</button>
          <button id="submitBtn" class="btn purple">Submit</button>
        </div>
      </div>
      <textarea id="editor" class="editor" spellcheck="false"></textarea>
      <div id="results" class="results"></div>
    </section>
    <aside class="right">
      <div class="ai-box">
        <h3>AI Assistant</h3>
        <p class="small">Get recommendations and snippets for this problem.</p>
        <textarea id="aiPrompt" placeholder="Describe your issue or what you want help with..."></textarea>
        <button id="askBtn" class="btn">Ask</button>
        <div id="aiOutput" class="ai-output"></div>
      </div>
    </aside>
  </main>

  <!-- CodeMirror 5 (simpler CDN, avoids ESM multiple instance issues) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/hint/show-hint.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/matchbrackets.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closebrackets.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/hint/show-hint.js"></script>
  <script>
    // Prettier for JS formatting
    // Loaded only once and used if available
  </script>
  <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/standalone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/parser-babel.js"></script>
  <script>
    function formatPythonLight(src){
      // Very lightweight, indentation-based reformatter (not full autopep8)
      const lines = src.replace(/\t/g, '    ').split(/\r?\n/);
      const out = [];
      let indent = 0;
      const dedentKeywords = /^(return|break|continue|pass|raise|elif\b|else\b|except\b|finally\b)/;
      for (let raw of lines){
        let s = raw.replace(/\s+$/,'');
        const trimmed = s.trim();
        if (trimmed.length===0){ out.push(''); continue; }
        // dedent for closing keywords
        if (dedentKeywords.test(trimmed)) indent = Math.max(0, indent - 1);
        // apply indent
        s = ' '.repeat(indent*4) + trimmed;
        out.push(s);
        // increase indent if line ends with ':'
        if (/:\s*(#.*)?$/.test(trimmed)) indent += 1;
      }
      return out.join('\n');
    }
    function formatCode(){
      const lang = document.getElementById('language').value;
      const code = window.cm.getCode();
      try {
        if (lang === 'javascript'){
          if (window.prettier && window.prettierPlugins && window.prettierPlugins.babel){
            const formatted = window.prettier.format(code, { parser: 'babel', plugins: [window.prettierPlugins.babel], semi: true, singleQuote: true });
            window.cm.setCode(formatted);
            return;
          }
        } else if (lang === 'python') {
          const formatted = formatPythonLight(code);
          window.cm.setCode(formatted);
          return;
        }
      } catch (e) {
        console.warn('Format failed:', e);
      }
      // Fallback: trim trailing spaces
      const fallback = code.split(/\r?\n/).map(l=>l.replace(/\s+$/,'')).join('\n');
      window.cm.setCode(fallback);
    }
    let cmInstance = null;
    function cmMode(lang){ return lang === 'python' ? 'text/x-python' : 'javascript'; }
    function cmIndent(lang){ return lang === 'python' ? 4 : 2; }
    function createEditor(initial, lang){
      const ta = document.getElementById('editor');
      cmInstance = CodeMirror.fromTextArea(ta, {
        value: initial || '',
        mode: cmMode(lang),
        lineNumbers: true,
        tabSize: cmIndent(lang),
        indentUnit: cmIndent(lang),
        smartIndent: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        extraKeys: {
          'Tab': cm => cm.replaceSelection(' '.repeat(cmIndent(lang))),
          'Ctrl-Space': 'autocomplete'
        }
      });
      setTimeout(() => cmInstance.refresh(), 0);
      cmInstance.focus();
      window.cmView = cmInstance;
      return cmInstance;
    }
    function setLanguage(lang){ if (cmInstance) { cmInstance.setOption('mode', cmMode(lang)); cmInstance.setOption('indentUnit', cmIndent(lang)); cmInstance.setOption('tabSize', cmIndent(lang)); } }
    function getCode(){ return cmInstance ? cmInstance.getValue() : document.getElementById('editor').value; }
    function setCode(v){ if (cmInstance) cmInstance.setValue(v || ''); else document.getElementById('editor').value = v || ''; }
    window.cm = { createEditor, setLanguage, getCode, setCode };
  
    const params = new URLSearchParams(location.search);
    const slug = params.get('slug');
    let currentProblem = null;

    async function loadProblem() {
      const res = await fetch(`/api/problems/${slug}`);
      if (!res.ok) {
        document.getElementById('title').textContent = 'Problem not found';
        return;
      }
      const p = await res.json();
      currentProblem = p;
      document.getElementById('title').textContent = p.title;
      document.getElementById('meta').textContent = `${p.difficulty}`;
      document.getElementById('tags').innerHTML = (p.tags||[]).map(t=>`<span class='chip'>${t}</span>`).join('');
      document.getElementById('statement').textContent = p.statement;
      // preload starter code
      const langSel = document.getElementById('language');
      const editorEl = document.getElementById('editor');
      function refreshStarter() {
        const lang = langSel.value;
        window.cm.setLanguage(lang);
        window.cm.setCode(p.starterCode[lang] || '');
      }
      langSel.addEventListener('change', refreshStarter);
      window.cm.createEditor('', langSel.value);
      refreshStarter();
    }

    async function runOrSubmit(mode) {
      const code = window.cm.getCode();
      const language = document.getElementById('language').value;
      const payload = { problemId: currentProblem.id, language, code };
      const res = await fetch('/api/judge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      const box = document.getElementById('results');
      if (data.error) {
        box.innerHTML = `<div class="error">${data.error}</div>`;
        return;
      }
      box.innerHTML = `
        <div class="status ${data.status}">Status: ${data.status} (${data.passed}/${data.total})</div>
        ${data.results.map(r => `
          <div class="case ${r.pass ? 'pass' : 'fail'}">
            <div><strong>Test ${r.test}:</strong> ${r.pass ? 'Pass' : 'Fail'}</div>
            <div class="mono">Input: ${JSON.stringify(r.input)}</div>
            ${r.error ? `<div class="error">Error: ${r.error}</div>` : `<div class="mono">Expected: ${JSON.stringify(r.expected)} | Got: ${JSON.stringify(r.got)}</div>`}
            ${r.timeMs ? `<div class="meta">Time: ${r.timeMs} ms</div>` : ''}
          </div>
        `).join('')}
      `;
    }

    async function askAI() {
      const prompt = document.getElementById('aiPrompt').value || `Help with problem: ${currentProblem.title}.`;
      const language = document.getElementById('language').value;
      const userCode = window.cm.getCode();
      const res = await fetch('/api/llm/suggest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, language, userCode, problemTitle: currentProblem.title, problemStatement: currentProblem.statement })
      });
      const data = await res.json();
      const out = document.getElementById('aiOutput');
      if (data.content) {
        out.textContent = data.content;
      } else {
        out.innerHTML = `
          <ul>
            ${(data.suggestions || []).map(s => `<li>${s}</li>`).join('')}
          </ul>
          ${data.snippet ? `<pre class="snippet">${data.snippet.replace(/</g, '&lt;')}</pre>` : ''}
        `;
      }
    }

    document.getElementById('runBtn').addEventListener('click', () => runOrSubmit('run'));
    document.getElementById('submitBtn').addEventListener('click', () => runOrSubmit('submit'));
    document.getElementById('formatBtn').addEventListener('click', formatCode);
    document.getElementById('askBtn').addEventListener('click', askAI);

    window.addEventListener('DOMContentLoaded', loadProblem);
  </script>
  <script src="/app.js"></script>
</body>
</html>
